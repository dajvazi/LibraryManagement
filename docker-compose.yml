services:
  app:
    build:
      context: .
      dockerfile: docker/dp/php/Dockerfile
    container_name: libmanagement_app
    ports:
      - "${APP_PORT:-8080}:80"
    volumes:
      - ./:/var/www/html
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASS: ""
      DB_NAME: libmanagement

      # Nëse e shton Ollama si service (shih poshtë)
      OLLAMA_BASE: http://ollama:11434
      CHAT_MODEL: gemma3:latest
      EMBED_MODEL: embeddinggemma:latest
    depends_on:
      db:
        condition: service_healthy
      ollama:
        condition: service_started
    restart: unless-stopped

  db:
    image: mariadb:11
    container_name: libmanagement_db
    environment:
      MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: "yes"
      MARIADB_DATABASE: libmanagement
      # (opsionale) vendos timezone
      TZ: Europe/Belgrade
    ports:
      - "${DB_PORT:-3307}:3306"
    volumes:
      - dbdata:/var/lib/mysql
      - ./docker/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      # Kjo punon më mirë se healthcheck.sh kur don "service_healthy"
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -u root --silent"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: libmanagement_pma
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      # optional:
      UPLOAD_LIMIT: 128M
    ports:
      - "${PMA_PORT:-8081}:80"
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  # --- Ollama (opsionale, por recommended) ---
  ollama:
    image: ollama/ollama:latest
    container_name: libmanagement_ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama:/root/.ollama
    restart: unless-stopped

volumes:
  dbdata:
  ollama:
